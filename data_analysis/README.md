# Generating figures
This directory includes all of the data and code to replicate the figures presented in Martin & Koelle 2021 which is a Technical Comment in response to Popa & Genger et al. Science Translational Medicine 2020. This directory includes the following scripts:

```
format_metadata.py
```
This is a fairly simply Python3 script which formats the various supplementary metadata files from Popa & Genger et al. into a single csv file. It is set up to be run from this directory (`sarscov2_nb_reanalysis/data_analysis`) and expects the `./data/abe2555_Data_file_S1_SampleInformation.csv`, `./data/abe2555_Data_file_S5.csv`, and `./data/abe2555_Data_file_S4.csv` files as input (available at https://stm.sciencemag.org/content/12/573/eabe2555/tab-figures-data) and requires Pandas to be installed. PLEASE NOTE: Sample CoV_159 does not have a family labelled in abe2555_Data_file_S4, HOWEVER, based on Fig. 5A and Fig. 5B in Popa & Genger et al. we have assumed that this patient belongs to Family 11. 

```
plot_figues.py
```
This is a Python3 script which is responsible for generating all of the figures. It requires the following files as input (all passed as arguments with the appropriate defaults):
* `--metadata`: `./data/abe255_Data_file_format.csv` as generated by the `format_metadata.py` file
* `--vcfDir`: VCF files with variants called relative to wuhan in the `./data/seq/*/*_filter_norm.vcf` path where `*` is the sample name (e.g. `CoV_041_S63682_sorted_viral_rh`). see `../variant_calling` for more on how these were generated. These files are provided as a tarball. 
* `--vcfRealignDir`: VCF files with variant calles realtive to the donor sequence in the `./data/seq_realign/*-@/@_filter_norm.vcf` path where `*` is the sample name and `@` is the sample name of the donor for that transmission pair. see `../variant_calling` for more on how these were generated. These files are provided as a tarball. 
* `--covDir`: TSV files with the sequencing depth at each position in the Wuhan/Hu-1 genome in the `./data/seq/*/*.cov` path where `*` is the sanem name. see `../variant_calling` for mor eon how these were generated. These files are provided as part of the VCF tarball. 
* `--simulatedData`: Simulated transmission pair data for alleles up to 6% with a bottleneck size of 1000 virions in the `./data/stochastic_sims_6percent.csv` file. see `../simulation` for more details on how these data were generated. 
* `--nbData`: Updated per transmisison pair NB estimates and confidence intervals in the `./data/Popa_new_Nb_estimates.csv` file. see `../nb_estimates` for more details on how these data were generated. 
* `--nbDataOverall`: Updated overall (combined across transmission pairs) NB estimates using all pairs and also only those pairs where the donor CT is <30 in the `./data//Nb_overall_data.csv` file. see `../nb_estimates` for more details on how these data were generated. 
* `--highlightPair`: a pair to highlight in Figure 1B. By default set to CoV_162 -> CoV_161. 
* `--filterAllow`: which strings in the `FILTER` columns of the input VCFs to allow as "passing." By default set to `PASS` and `min-af_0.010000` as we want more control over the min variant frequency throughout our analysis. 
* `--primerSchemer`: bed file with the primer scheme used in the `./data/nCoV-2019.scheme_modif.bed` file. 

This script depends on standard Python dependencies including Pandas, Numpy, Matplotlib, and Scipy. 

```
calc_stats.py
```
This is a python3 script which conducts all of the statistical analyses presented in the paper. This includes:
1. Paired t-test comparing bottleneck estimates using a 1% variant frequency cutoff and 3% variant frequency. 
2. K-S test comparing the distribution of proportion of variants shared at 1-2%, 2-3%, and 3-6% between non transmission pairs and random pairs. This step reads in the same random pair file as the figure script. 
3. The proportion of variants present at between 2% and 6% for all samples with an estimated bottleneck size >= 1000 (using a 1% variant calling threshold) which are present in the recipient at >= 1% frequency. 

This script takes the following files as input: 
* `--metadata`: `./data/abe255_Data_file_format.csv` as generated by the `format_metadata.py` file
* `--vcfDir`: VCF files with variants called relative to wuhan in the `./data/seq/*/*_filter_norm.vcf` path where `*` is the sample name (e.g. `CoV_041_S63682_sorted_viral_rh`). see `../variant_calling` for more on how these were generated. These files are provided as a tarball. 
* `--vcfRealignDir`: VCF files with variant calles realtive to the donor sequence in the `./data/seq_realign/*-@/@_filter_norm.vcf` path where `*` is the sample name and `@` is the sample name of the donor for that transmission pair. see `../variant_calling` for more on how these were generated. These files are provided as a tarball. 
* `--nbData`: Updated per transmisison pair NB estimates and confidence intervals in the `./data/Popa_new_Nb_estimates.csv` file. see `../nb_estimates` for more details on how these data were generated. 
* `--filterAllow`: which strings in the `FILTER` columns of the input VCFs to allow as "passing." By default set to `PASS` and `min-af_0.010000` as we want more control over the min variant frequency throughout our analysis. 
* `data/random_pairs.csv`: file with random donor-recipient pairs as generated by the `./scripts/plot_figures.py` file. Be careful to make sure you conduct the statistical tests on the same random pairing file which was used to generate the plot. 

This script includes standard Python dependencies such as Pandas, Numpy, and Scipy.
